<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Advertising</title>
</head>
<body class="bg-primary-bg text-text-primary p-6 h-screen flex flex-col overflow-hidden">
  <!-- Standardized Draggable Header with Minimize and Close Buttons -->
  <div style="-webkit-app-region: drag;" class="flex items-center justify-between bg-secondary-bg rounded-t-md px-4 py-2 mb-2 select-none">
    <span class="font-bold text-lg">Auto Advertising</span>
    <div class="flex items-center" style="-webkit-app-region: no-drag;">
      <button id="minimize-btn" class="text-gray-400 hover:text-highlight-blue focus:outline-none px-2 mr-1 transition-colors">
        <i class="fas fa-minus"></i>
      </button>
      <button onclick="window.close()" class="text-gray-400 hover:text-error-red focus:outline-none px-2 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="flex-1 flex flex-col h-full">
    <div class="bg-secondary-bg rounded-md shadow p-4 mb-4">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-lg font-medium text-text-primary">Auto Advertising</h1>
          <p class="text-sm text-gray-400 mt-1">Set up automated messages to be sent periodically</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="status-indicator" class="px-2 py-1 text-xs rounded-full bg-error-red/20 text-error-red">
            <i class="fas fa-circle mr-1"></i> Inactive
          </span>
        </div>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto mb-4 pr-1" style="max-height: calc(100% - 180px)">
      <div class="bg-secondary-bg rounded-md shadow p-4 space-y-4 mb-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-base font-medium text-text-primary">Message Rotation</h2>
          <div class="text-xs text-gray-400">
          </div>
        </div>

        <div id="messages-container" class="space-y-3">
        </div>

        <div class="flex justify-center mt-4">
          <button id="add-message-btn"
            class="px-4 py-2 bg-tertiary-bg hover:bg-sidebar-hover text-text-primary rounded-md transition text-sm">
            <i class="fas fa-plus mr-2"></i> Add Message
          </button>
        </div>
      </div>

      <div class="bg-secondary-bg rounded-md shadow p-4 space-y-4 mb-4">
        <h2 class="text-base font-medium text-text-primary mb-3">Settings</h2>

        <div class="flex flex-wrap gap-4">
          <div class="flex-1 min-w-[200px]">
            <label for="interval" class="block text-xs font-medium text-gray-400 mb-1">Interval (seconds)</label>
            <input type="number" id="interval" min="10" value="60"
              class="w-full bg-tertiary-bg text-text-primary placeholder-gray-400 p-2 rounded-md focus:outline-none focus:ring-1 focus:ring-highlight-green text-sm">
            <p class="mt-1 text-xs text-gray-400">Minimum 10 seconds recommended</p>
          </div>

          <div class="flex-1 min-w-[200px]">
            <label for="order-type" class="block text-xs font-medium text-gray-400 mb-1">Message Order</label>
            <select id="order-type"
              class="w-full bg-tertiary-bg text-text-primary p-2 rounded-md focus:outline-none focus:ring-1 focus:ring-highlight-green text-sm">
              <option value="sequential">Sequential</option>
              <option value="random">Random</option>
            </select>
            <p class="mt-1 text-xs text-gray-400">How messages will be rotated</p>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-secondary-bg rounded-md shadow p-4 sticky bottom-0">
      <div class="grid grid-cols-2 gap-2 sm:gap-4">
        <!-- Save/Load buttons in first column -->
        <div class="flex gap-2">
          <button id="save-btn"
            class="flex-1 px-3 py-2 bg-tertiary-bg hover:bg-sidebar-hover text-text-primary rounded-md transition text-sm flex items-center justify-center">
            <i class="fas fa-save mr-1"></i> Save
          </button>
          <button id="load-btn"
            class="flex-1 px-3 py-2 bg-tertiary-bg hover:bg-sidebar-hover text-text-primary rounded-md transition text-sm flex items-center justify-center">
            <i class="fas fa-folder-open mr-1"></i> Load
          </button>
        </div>

        <!-- Start/Stop buttons in second column - always visible -->
        <div class="flex gap-2">
          <button id="start-btn"
            class="flex-1 px-3 py-2 bg-highlight-green/20 hover:bg-highlight-green/30 text-highlight-green rounded-md transition text-sm flex items-center justify-center">
            <i class="fas fa-play mr-1"></i> Start
          </button>
          <button id="stop-btn" disabled
            class="flex-1 px-3 py-2 bg-error-red/20 hover:bg-error-red/30 text-error-red rounded-md transition text-sm flex items-center justify-center">
            <i class="fas fa-stop mr-1"></i> Stop
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

  <input type="file" id="file-input" accept=".json" class="hidden">

  <template id="message-template">
    <div class="message-input bg-tertiary-bg/30 p-3 rounded-md border border-sidebar-border hover:border-highlight-green transition-colors">
      <div class="flex items-center justify-between mb-2">
        <label class="text-xs font-medium text-gray-400 message-label">Message</label>
        <div class="flex items-center gap-2">
          <button class="text-xs text-gray-400 hover:text-highlight-green transition-colors px-2 py-1 rounded hover:bg-tertiary-bg/50 preview-btn">
            <i class="fas fa-eye mr-1"></i> Preview
          </button>
          <button class="text-xs text-error-red hover:text-error-red/80 transition-colors px-2 py-1 rounded hover:bg-tertiary-bg/50 remove-btn">
            <i class="fas fa-trash mr-1"></i> Remove
          </button>
        </div>
      </div>
      <textarea class="w-full bg-tertiary-bg text-text-primary placeholder-gray-400 p-2 rounded-md focus:outline-none focus:ring-1 resize-y min-h-[60px] text-sm message-content" placeholder="Enter your advertisement message here..."></textarea>
    </div>
  </template>

  <script>
    // -- Global Variables ---
    const IS_DEV = true; // Set to false for production builds to disable logs
    let advertisingDispatch = null; // Global variable to hold the dispatch object
    let isActive = false;
    let messageTimerId = null;
    let messageIndex = 0;

    // --- Utility Functions ---

    /**
     * Adds a new message input box to the container
     */
    function addMessageBox() {
      const $messagesContainer = $('#messages-container');
      const $messageTemplate = $('#message-template');
      const messageCount = $messagesContainer.children().length + 1;
      const $newMessage = $($messageTemplate.html());

      $newMessage.find('.message-label').text(`Message ${messageCount}`);

      $newMessage.find('.preview-btn').on('click', function() {
        const message = $(this).closest('.message-input').find('.message-content').val();
        previewMessage(message);
      });

      $newMessage.find('.remove-btn').on('click', function() {
        if ($messagesContainer.children().length <= 1) {
          showToast("You must have at least one message", "warning");
          return;
        }

        $(this).closest('.message-input').remove();
        updateMessageLabels();
      });

      $messagesContainer.append($newMessage);
      
      $messagesContainer.parent().parent().animate({
        scrollTop: $messagesContainer.height()
      }, 300);
    }

    /**
     * Updates the labels for all message boxes to show the correct sequence
     */
    function updateMessageLabels() {
      $('.message-input').each(function(index) {
        $(this).find('.message-label').text(`Message ${index + 1}`);
      });
    }

    /**
     * Retrieves all message content from the UI
     * @returns {Array<string>} Array of all message texts
     */
    function getAllMessages() {
      const messages = [];
      $('.message-content').each(function() {
        messages.push($(this).val());
      });
      return messages;
    }

    /**
     * Starts the advertising rotation
     */
    function startAdvertising() {
      if (isActive) return;

      const $startBtn = $('#start-btn');
      const $stopBtn = $('#stop-btn');
      const $statusIndicator = $('#status-indicator');
      const $intervalInput = $('#interval');

      const messages = getAllMessages();

      const hasMessage = messages.some(msg => msg.trim() !== "");
      if (!hasMessage) {
        showToast("Please enter at least one message", "error");
        return;
      }

      const interval = Math.max(10, parseInt($intervalInput.val()) || 60);
      $intervalInput.val(interval);

      isActive = true;
      messageIndex = 0;

      $startBtn.prop('disabled', true);
      $stopBtn.prop('disabled', false);
      $statusIndicator
        .removeClass('bg-error-red/20 text-error-red')
        .addClass('bg-highlight-green/20 text-highlight-green')
        .html('<i class="fas fa-circle mr-1"></i> Active');

      // Start the first message send immediately, then schedule subsequent ones
      sendNextMessage(); 

      showToast("Auto advertising started", "success");
    }

    /**
     * Stops the advertising rotation
     */
    function stopAdvertising() {
      if (!isActive) return;

      const $startBtn = $('#start-btn');
      const $stopBtn = $('#stop-btn');
      const $statusIndicator = $('#status-indicator');

      if (messageTimerId) {
          clearTimeout(messageTimerId); // Use clearTimeout
          messageTimerId = null;
      }
      isActive = false;

      $startBtn.prop('disabled', false);
      $stopBtn.prop('disabled', true);
      $statusIndicator
        .removeClass('bg-highlight-green/20 text-highlight-green')
        .addClass('bg-error-red/20 text-error-red')
        .html('<i class="fas fa-circle mr-1"></i> Inactive');

      showToast("Auto advertising stopped", "warning");
    }

    /**
     * Sends the next message in the rotation and schedules the next one
     */
    async function sendNextMessage() {
      // Check if still active before sending
      if (!isActive || !advertisingDispatch) {
        if (IS_DEV) console.error("Advertising: Cannot send message - inactive or dispatch not ready");
        return;
      }

      const $orderType = $('#order-type');
      const $intervalInput = $('#interval');

      if (IS_DEV) console.log("Advertising: sendNextMessage called");
      const messages = getAllMessages().filter(msg => msg.trim() !== "");
      const interval = Math.max(10, parseInt($intervalInput.val()) || 60); // Get interval

      // Define function to schedule next send
      const scheduleNext = () => {
        if (IS_DEV) console.log("Advertising: Scheduling next message in " + interval + " seconds");
        if (isActive) { // Double-check isActive before scheduling
          messageTimerId = setTimeout(sendNextMessage, interval * 1000);
        }
      };

      if (messages.length === 0) {
        if (IS_DEV) console.warn("Advertising: No messages to send. Stopping.");
        showToast("No messages to send. Stopping.", "warning");
        stopAdvertising();
        return;
      }

      let messageToSend;
      if ($orderType.val() === "random") {
        const randomIndex = Math.floor(Math.random() * messages.length);
        messageToSend = messages[randomIndex];
      } else {
        if (messageIndex >= messages.length) {
          messageIndex = 0;
        }
        messageToSend = messages[messageIndex];
        messageIndex++;
      }

      if (IS_DEV) console.log("Advertising: About to check room state...");
      
      // Use multiple methods to try to get room info
      let room;
      try {
        // Try using window.jam.state first (most reliable)
        if (window.jam && window.jam.state && window.jam.state.room) {
          room = window.jam.state.room;
          if (IS_DEV) console.log("Advertising: Room from window.jam.state:", room);
        }
        
        // If that didn't work, try dispatch.getState
        if (!room && advertisingDispatch.getState) {
          room = await advertisingDispatch.getState('room');
          if (IS_DEV) console.log("Advertising: Room from getState:", room);
        }
        
        // If that didn't work, try getStateSync
        if (!room && typeof advertisingDispatch.getStateSync === 'function') {
          room = advertisingDispatch.getStateSync('room');
          if (IS_DEV) console.log("Advertising: Room from getStateSync:", room);
        }
      } catch (err) {
        if (IS_DEV) console.error("Advertising: Error getting room state:", err);
      }
      
      if (!room) {
        if (IS_DEV) console.warn("Advertising: Not in a room, can't send message");
        showToast("You must be in a room to send messages", "error");
        scheduleNext(); // Schedule next attempt even if not in room
        return;
      }
      
      if (IS_DEV) console.log(`Advertising: About to send message in room: ${room}`);

      try {
        // Use %9 as the suffix for chat messages as per game protocol
        const packet = `<msg t="sys"><body action="pubMsg" r="${room}"><txt><![CDATA[${messageToSend}%9]]></txt></body></msg>`;
        if (IS_DEV) console.log(`Advertising: Sending packet: ${packet}`);
        
        // Try to send message
        const result = await advertisingDispatch.sendRemoteMessage(packet);
        if (IS_DEV) console.log("Advertising: Message sent successfully, result:", result);
        showToast("Message sent successfully", "success");
      } catch (error) {
        if (IS_DEV) console.error("Advertising: Error sending message:", error);
        showToast("Error sending message. Will retry.", "error");
      } finally {
         // Always schedule the next message send in the finally block if still active
         scheduleNext();
      }
    }

    /**
     * Saves the current configuration to a JSON file
     */
    function saveConfig() {
      const $intervalInput = $('#interval');
      const $orderType = $('#order-type');

      const config = {
        interval: parseInt($intervalInput.val()),
        orderType: $orderType.val(),
        messages: getAllMessages()
      };

      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const $a = $('<a>')
        .attr({
          href: url,
          download: `advertising-config-${new Date().toISOString().slice(0, 10)}.json`
        })
        .appendTo('body');

      $a[0].click();
      $a.remove();
      URL.revokeObjectURL(url);

      showToast("Configuration saved", "success");
    }

    /**
     * Triggers file selection dialog to load a configuration file
     */
    function loadConfig() {
      const $fileInput = $('#file-input');
      $fileInput.trigger('click');
    }

    /**
     * Sends a preview message to the current room
     * @param {string} message - The message to preview/send
     */
    async function previewMessage(message) {
      if (!advertisingDispatch) {
        if (IS_DEV) console.error("Advertising: Cannot preview - dispatch not ready");
        showToast("System not ready. Try again in a moment.", "error");
        return;
      }

      if (IS_DEV) console.log("Advertising: previewMessage called with:", message);
      
      if (!message || message.trim() === "") {
        if (IS_DEV) console.warn("Advertising: No message content to preview");
        showToast("No message to preview", "error");
        return;
      }

      if (IS_DEV) console.log("Advertising: About to check room state for preview...");
      
      // Use multiple methods to try to get room info
      let room;
      try {
        // Try using window.jam.state first (most reliable)
        if (window.jam && window.jam.state && window.jam.state.room) {
          room = window.jam.state.room;
          if (IS_DEV) console.log("Advertising: Preview - Room from window.jam.state:", room);
        }
        
        // If that didn't work, try dispatch.getState
        if (!room && advertisingDispatch.getState) {
          room = await advertisingDispatch.getState('room');
          if (IS_DEV) console.log("Advertising: Preview - Room from getState:", room);
        }
        
        // If that didn't work, try getStateSync
        if (!room && typeof advertisingDispatch.getStateSync === 'function') {
          room = advertisingDispatch.getStateSync('room');
          if (IS_DEV) console.log("Advertising: Preview - Room from getStateSync:", room);
        }
      } catch (err) {
        if (IS_DEV) console.error("Advertising: Preview - Error getting room state:", err);
      }
      
      if (!room) {
        if (IS_DEV) console.warn("Advertising: Preview - Not in a room, can't send message");
        showToast("You must be in a room to send a preview message", "error");
        return;
      }
      
      if (IS_DEV) console.log(`Advertising: Preview - About to send message in room: ${room}`);

      try {
        // Construct and send the packet
        const packet = `<msg t="sys"><body action="pubMsg" r="${room}"><txt><![CDATA[${message}%9]]></txt></body></msg>`;
        if (IS_DEV) console.log(`Advertising: Preview - Sending packet: ${packet}`);
        
        // Try to send message
        const result = await advertisingDispatch.sendRemoteMessage(packet);
        if (IS_DEV) console.log("Advertising: Preview - Message sent successfully, result:", result);
        showToast("Preview message sent!", "success");
      } catch (error) {
        if (IS_DEV) console.error("Advertising: Preview - Error sending preview message:", error);
        showToast("Error sending preview message", "error");
      }
    }

    /**
     * Displays a toast notification
     * @param {string} message - The message to display
     * @param {string} type - The notification type: 'success', 'error', 'warning', or 'info'
     */
    function showToast(message, type = 'success') {
      const $toastContainer = $('#toast-container');

      const toastClasses = {
        success: 'bg-highlight-green text-white',
        error: 'bg-error-red text-white',
        warning: 'bg-highlight-yellow text-white',
        info: 'bg-blue-400 text-white'
      };

      const $toast = $('<div>')
        .addClass(`px-4 py-2 rounded shadow-lg mb-2 flex items-center ${toastClasses[type] || toastClasses.info}`)
        .html(`
          <i class="fas fa-${
            type === 'success' ? 'check-circle' :
            type === 'error' ? 'times-circle' :
            type === 'warning' ? 'exclamation-circle' :
            'info-circle'
          } mr-2"></i>
          ${message}
        `);

      $toastContainer.append($toast);

      setTimeout(() => {
        $toast.css({
          'opacity': '0',
          'transition': 'opacity 0.5s'
        });
        setTimeout(() => $toast.remove(), 500);
      }, 3000);
    }

    // --- File Input Handler ---
    function handleFileInput(event) {
      try {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const text = e.target.result;
            const config = JSON.parse(text);

            const $intervalInput = $('#interval');
            const $orderType = $('#order-type');
            const $messagesContainer = $('#messages-container');

            $intervalInput.val(config.interval || 60);
            $orderType.val(config.orderType || "sequential");

            if (Array.isArray(config.messages)) {
              $messagesContainer.empty();

              config.messages.forEach(() => {
                addMessageBox();
              });

              $('.message-content').each((index, element) => {
                if (index < config.messages.length) {
                  $(element).val(config.messages[index]);
                }
              });

              if (config.messages.length === 0) {
                addMessageBox();
              }
            }

            showToast("Configuration loaded", "success");
          } catch (error) {
            if (IS_DEV) console.error("Error processing file:", error);
            showToast("Error loading configuration", "error");
          }
        };
        reader.readAsText(file);
      } catch (error) {
        if (IS_DEV) console.error("Error loading configuration:", error);
        showToast("Error loading configuration", "error");
      }

      $('#file-input').val("");
    }

    // --- Initialization ---
    function waitForDispatch() {
      if (typeof window.jam === 'undefined' || typeof window.jam.dispatch === 'undefined') {
        if (IS_DEV) console.log("Advertising Plugin: Waiting for window.jam.dispatch...");
        setTimeout(waitForDispatch, 100); // Check again in 100ms
        return;
      }
      
      if (IS_DEV) console.log("Advertising Plugin: Dispatch ready, initializing.");
      advertisingDispatch = window.jam.dispatch; // Store dispatch globally for use in functions
      
      // Initialize the UI - add first message box
      addMessageBox();

      // Attach event listeners
      $(document).ready(function() {
        $('#add-message-btn').on('click', addMessageBox);
        $('#start-btn').on('click', startAdvertising);
        $('#stop-btn').on('click', stopAdvertising);
        $('#save-btn').on('click', saveConfig);
        $('#load-btn').on('click', loadConfig);
        $('#file-input').on('change', handleFileInput);
        
        // Clean up on window close
        $(window).on('beforeunload', stopAdvertising);
      });
    }

    // Set up the minimize button functionality with DOM-ready check
    document.addEventListener('DOMContentLoaded', function() {
      const minimizeBtn = document.getElementById('minimize-btn');
      if (minimizeBtn) {
        minimizeBtn.addEventListener('click', () => {
          if (window.jam && window.jam.application) {
            window.jam.application.minimize();
          } else {
            // Fallback if jam.application is not available
            try {
              const { ipcRenderer } = require('electron');
              ipcRenderer.send('window-minimize');
            } catch (e) {
              console.error("[Advertising] Error minimizing window:", e);
            }
          }
        });
      }
    });

    // Start the initialization check
    waitForDispatch();
  </script>
</body>
</html>
